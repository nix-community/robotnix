<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Development - Robotnix</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="welcome.html"><strong aria-hidden="true">1.</strong> Welcome to robotnix</a></li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">2.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="modules/flavors.html"><strong aria-hidden="true">2.1.</strong> Flavors</a></li><li class="chapter-item expanded "><a href="modules/f-droid.html"><strong aria-hidden="true">2.2.</strong> F-Droid</a></li><li class="chapter-item expanded "><a href="modules/seedvault.html"><strong aria-hidden="true">2.3.</strong> Seedvault Backup</a></li><li class="chapter-item expanded "><a href="modules/microg.html"><strong aria-hidden="true">2.4.</strong> MicroG</a></li><li class="chapter-item expanded "><a href="modules/ota.html"><strong aria-hidden="true">2.5.</strong> Over-the-Air (OTA) Updater</a></li><li class="chapter-item expanded "><a href="modules/browsers.html"><strong aria-hidden="true">2.6.</strong> Browsers / Webview</a></li><li class="chapter-item expanded "><a href="modules/attestation.html"><strong aria-hidden="true">2.7.</strong> Remote Attestation</a></li><li class="chapter-item expanded "><a href="modules/prebuilt.html"><strong aria-hidden="true">2.8.</strong> Prebuilt Apps</a></li><li class="chapter-item expanded "><a href="modules/source.html"><strong aria-hidden="true">2.9.</strong> Source Directories</a></li><li class="chapter-item expanded "><a href="modules/other.html"><strong aria-hidden="true">2.10.</strong> Other Modules</a></li></ol></li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">3.</strong> Building</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">4.</strong> Installation / Updating</a></li><li class="chapter-item expanded "><a href="development.html" class="active"><strong aria-hidden="true">5.</strong> Development</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Reference</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="options.html"><strong aria-hidden="true">6.1.</strong> Options</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Robotnix</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!--
SPDX-FileCopyrightText: 2021 Daniel Fullmer and robotnix contributors
SPDX-License-Identifier: MIT
-->
<h1 id="development"><a class="header" href="#development">Development</a></h1>
<p>Robotnix modules use the same Nix-based module system used in NixOS.
To understand the NixOS module system, please <a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-modules">read this</a>.</p>
<p>Robotnix does not primarily aim to significantly decrease the complexity of Android development,
but rather (once a developer has a working build) makes it easier to share that work with others.</p>
<p>As such, robotnix does not replace the existing Android build system, but provides a convenient Nix-based wrapper around the build system.
(See <a href="https://github.com/danielfullmer/blueprint2nix">blueprint2nix</a> and <a href="https://github.com/danielfullmer/soongnix">soongnix</a> for an experimental attempt at reimplementing part of the Android build system natively in Nix.)</p>
<p>Feel free to ask robotnix development questions in <code>#robotnix:nixos.org</code> on Matrix.</p>
<h2 id="git-mirrors"><a class="header" href="#git-mirrors">Git mirrors</a></h2>
<p>Robotnix can be configured to use local git mirrors of Android source code.
The AOSP documentation includes instructions to <a href="https://source.android.com/setup/build/downloading#using-a-local-mirror">create a local mirror of the Android source code</a>.
Maintaining a local mirror can save bandwidth in the long-run when repeatedly updating a flavor over time which contains incremental updates.</p>
<p>This functionality is enabled by setting the <code>ROBOTNIX_GIT_MIRRORS</code> environment variable.
The value of <code>ROBOTNIX_GIT_MIRRORS</code> contains a number of mappings, each separated by a <code>|</code> character.
Each mapping is of the format <code>&lt;remote_url&gt;=&lt;local_url&gt;</code>.
For example:</p>
<pre><code>ROBOTNIX_GIT_MIRRORS=https://android.googlesource.com=/mnt/cache/mirror|https://github.com/LineageOS=/mnt/cache/lineageos/LineageOS
</code></pre>
<p>Both the robotnix update scripts as well as robotnix's overridden <code>fetchgit</code> derivation use <code>ROBOTNIX_GIT_MIRRORS</code>.
This environment variable is passed to <code>fetchgit</code> via <code>impureEnvVars</code> (search for <code>impureEnvVars</code> in the <a href="https://nixos.org/manual/nix/stable/">Nix manual</a>).
If the Nix daemon is being used, it needs to have this <code>ROBOTNIX_GIT_MIRRORS</code> in its environment, not just in the user's environment when running <code>nix-build</code> or <code>nix build</code>.
The following NixOS configuration can be used to easily set this environment variable for the Nix daemon:</p>
<pre><code class="language-nix">let
  mirrors = {
    &quot;https://android.googlesource.com&quot; = &quot;/mnt/cache/mirror&quot;;
    &quot;https://github.com/LineageOS&quot; = &quot;/mnt/cache/lineageos/LineageOS&quot;;
  };
in
{
  nix.envVars.ROBOTNIX_GIT_MIRRORS = lib.concatStringsSep &quot;|&quot; (lib.mapAttrsToList (local: remote: &quot;${local}=${remote}&quot;) mirrors);

  # Also add local mirrors to nix sandbox exceptions
  nix.sandboxPaths = lib.attrValues mirrors;
}
</code></pre>
<h2 id="helper-scripts"><a class="header" href="#helper-scripts">Helper scripts</a></h2>
<p>Robotnix can produce a few helper scripts that can make Android development easier in some circumstances.</p>
<p>Running <code>nix-build --arg configuration &lt;cfg&gt; -A &lt;output&gt;</code> for the outputs below will produce the corresponding helper script, using the provided robotnix configuration.</p>
<ul>
<li><code>config.build.debugEnterEnv</code> produces a script which enters an FHS environment with the required dependencies, as well as the Android source files bind-mounted under the current directory.  Useful in conjunction with <code>cd $(mktemp -d)</code> to enter a temporary directory.  Files are bind-mounted readonly, so files cannot be edited ad-hoc using this script.</li>
</ul>
<p>The following outputs can be useful with an existing Android source checkout made using <code>repo</code>.</p>
<ul>
<li><code>config.build.env</code> produces a <code>robotnix-build</code> script under <code>bin/</code> which enters an FHS environment that contains all required dependencies to build Android.</li>
<li><code>config.build.debugUnpackScript</code> produces a script which will copy the robotnix-specific source directories into <code>./robotnix/</code>.</li>
<li><code>config.build.debugPatchScript</code> produces a script which will patch all Android source directories under the current directory in a similar way they would be patched during a normal robotnix build.</li>
</ul>
<h2 id="external-modules"><a class="header" href="#external-modules">External modules</a></h2>
<p>Robotnix is welcome to contributions of well-written modules that can be maintained in an ongoing fashion.
Modules can provide support for new flavors, additional devices with an existing flavor, included system/privileged applications, and others.</p>
<p>If the proposed module is not suitable for inclusion as an upstream robotnix module,
it can still be developed and maintained externally and easily included by a user.
This can be done in a similar way as is done with NixOS modules.
For instance, if the module is provided by <code>default.nix</code> in the <code>owner/repo</code> repository on GitHub:</p>
<pre><code class="language-nix">{
    imports = [ (builtins.fetchTarball {
        url = &quot;https://github.com/owner/repo/archive/9b034054166e1f01b3bdb6a1948daa3bdafe039a.tar.gz&quot;;
        sha256 = &quot;0000000000000000000000000000000000000000000000000000000000000000&quot;;
    }) ];
}
</code></pre>
<p>The above <code>imports</code> statement will include the provided module in the robotnix build, pinned by the provided revision and <code>sha256</code>.
Any options or configuration set by the specified module will be included in the build.</p>
<h2 id="developing-a-new-flavor"><a class="header" href="#developing-a-new-flavor">Developing a new flavor</a></h2>
<p>To create a new flavor, the developer should create a robotnix module that conditions on <code>config.flavor</code>.
The flavor configuration defaults should be set conditionally using (for example) <code>mkIf (config.flavor = &quot;...&quot;) { ... }</code>.
Those configuration defaults should include:</p>
<ul>
<li>Setting <code>source.dirs</code> using a repo JSON file produced by <code>mk_repo_file.py</code>.</li>
<li>Setting the default <code>androidVersion</code>.</li>
<li>Setting the default <code>buildDateTime</code> based on (for example) the time that the flavor was last updated.</li>
<li>Providing a warning if the user has not selected a valid device for this flavor.</li>
</ul>
<p>Additionally, flavors should provide update scripts that can (at least) automatically produce an updated repo JSON file.
It is recommended to take a look at the Nix expressions implementing the current flavors under <code>flavors/</code>.</p>
<h2 id="emulator"><a class="header" href="#emulator">Emulator</a></h2>
<p>Robotnix can also build a script which will start the Android emulator using an attached robotnix-built system image.
This can be accomplished with the <code>emulator</code> Nix output.
To build and run an emulator with an attached vanilla system image, use (for example):</p>
<pre><code class="language-console">$ nix-build ./default.nix --arg configuration '{device=&quot;x86_64&quot;; flavor=&quot;vanilla&quot;;}' -A emulator
$ ./result
</code></pre>
<p>This currently only works well when using the generic <code>x86_64</code> device.</p>
<h2 id="testing--ci--reproducibility"><a class="header" href="#testing--ci--reproducibility">Testing / CI / Reproducibility</a></h2>
<p>All devices (Pixel 3-5(a) (XL)) have very basic checks to ensure that the android build process will at least start properly.
See <code>release.nix</code> for the set of configurations with this minimal build testing.
This check is run using <code>nix-build ./release.nix -A check</code>.
As each build takes approximately 4 hours--I only build marlin and crosshatch builds for myself.
At some point, I would love to set up a build farm and publish build products on s3 or <a href="https://cachix.org">cachix</a>.
This would allow an end-user to simply sign releases using their own keys without building the entire AOSP themselves.</p>
<p>As of 2020-05-17, <code>target_files</code>, <code>signed_target_files</code>, <code>img</code>, and <code>ota</code> files have all been verified to be bit-for-bit reproducible for <code>crosshatch</code> and <code>marlin</code> using the <code>vanilla</code> flavor.
Automated periodic testing of this is still desired.</p>
<p>One option being investigated is to have multiple independent remote builders produce unsigned target files for a number of device and flavor combinations.
An end-user could then verify that the builders produced the same unsigned target files, and finish the process by signing the target files and producing their own <code>img</code> and <code>ota</code> files.
This eliminates the requirement for an end-user to spend hours building android.</p>
<p>There are, however, a few places where user-specific public keys are included in the build for key pinning.
This unfortunately decreases the possibility of sharing build products between users.
The F-Droid privileged extension and Trichrome (disabled for now) are two components which have this issue.
Fixes for this are still under investigation.</p>
<h2 id="building-individual-android-components"><a class="header" href="#building-individual-android-components">Building individual android components</a></h2>
<p>For convenience, individual android components may be easily built using the <code>components.nix</code> at the root of the repo.
For example, to build <code>adb</code>, run</p>
<pre><code class="language-console">$ nix-build ./components.nix -A adb
</code></pre>
<p>The set of components available may be found in <code>components.json</code>.</p>
<p>Only what Android considers the &quot;installed output&quot; of the components is copied into the resuting derivation, and not &quot;intermediate&quot; results.
Sometimes these intermediate results are what is desired, in which case the user should manually set the <code>installPhase</code> for a <code>mkAndroid</code> invokation.
For more detailed information about what exactly these components produce as &quot;installed output&quot;, see the <code>config.build.moduleInfo</code> output for a build.</p>
<h2 id="additional-notes"><a class="header" href="#additional-notes">Additional Notes</a></h2>
<p>Robotnix bind mounts the source directories from <code>/nix/store</code>.
These files/directories have their &quot;user write&quot; (<code>u-w</code>) permission removed.
Sometimes, Android Makefiles which copy files from the source directories may assume the files have the write permission enabled, which can then break later steps.
To work around these issues, it is usually sufficient to add a <code>chmod</code> command or add <code>--no-preserve=owner,mode</code> to the <code>cp</code> command in the Makefile.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="installation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="options.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="installation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="options.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
