# repo2nix

This is the robotnix tooling for handling `git-repo` manifest files. Its main
purpose is to generate lockfiles for manifests such that we can import the
projects into the robotnix Nix module system, but it also does some other minor
stuff needed for the quirks of the downstream Android distributions we support.

The `repo-manifest` crate contains some library functions for basic git-repo
manifest handling, and the `repo-tool` crate contains the actual CLI.

## `repo-tool` commands

### `repo-tool fetch`

Generates a lockfile for a `git-repo` manifest. Additionally supports fetching
LineageOS device-specific dependencies as specified in the
`lineage.dependencies` files in the LineageOS device repos, and proprietary
vendor files from the GitHub `TheMuppets` org.

GrapheneOS example:

```console
$ repo-tool fetch --tag -r 2025070800 https://github.com/GrapheneOS/platform_manifest grapheneos.lock
```

LineageOS example:

```console
$ repo-tool fetch --tag -r lineage-22.2 -l lineage_devices.json --muppets https://github.com/LineageOS/android lineage-22.lock -m lineage_missing_dep_devices.json
```

Positional arguments:

- `MANIFEST_URL`: The git URL of the `git-repo` manifest to generate a lockfile for.
- `LOCKFILE`: The path to save the generated lockfile to.

Options:

- `-r, --revision <REVISION>`: Fetch the given branch (or tag if `--tag` is
  given) from the manifest repo.
- `-t, --tag`: Interpret the `-r` argument as a git tag instead of as a git
  branch.
- `-l, --lineage-device-file <FILE>`: Activates LineageOS device-specific
  dependency fetching, and read the LineageOS device metadata (as generated by
  `repo-tool get-lineage-devices`) from `FILE`. Can be specified multiple times
  to read device metadata from multiple sources.
- `-m, --missing-dep-devs-file <FILE>`: Write the list of devices with missing
  LineageOS dependencies (either missing `lineage.dependencies` entries or
  missing `TheMuppets` branches) to FILE.
- `--muppets`: Fetch the proprietary vendor repositories for all devices from
  the GitHub `TheMuppets` org.


### `repo-tool ensure-store-paths`

Ensures that the locked `git-repo` projects from some `repo2nix` lockfile are
present in the Nix store, in case we want to extract some information from them
in updater scripts.

Usage:

```console
# Ensure that all projects as locked in `graphene.lock` are present in the Nix store:
$ repo-tool ensure-store-paths graphene.lock
# Same, but only for the `vendor/adevtool` and `build/make` projects:
$ repo-tool ensure-store-paths graphene.lock vendor/adevtool build/make
```

### `repo-tool get-build-id`

Reads the build ID from the `core/build_id.mk` file of the `build/make` project of the specified lockfile(s) and writes the result to the specified output file.

Usage:

```console
$ repo-tool get-build-id build_ids.json graphene-2025012701.lock graphene-2-2025021000.lock graphene-2025080600.lock
$ cat build_ids.json
{
  "graphene-2025012701.lock": "TQ3A.230901.001",
  "graphene-2025021000.lock": "AP2A.240905.003",
  "graphene-2025080600.lock": "BP2A.250605.031.A2"
}
```

### `repo-tool get-lineage-devices`

Fetches a list of all officially supported LineageOS devices from the
`github:LineageOS/hudson` repo, additionally checks for unofficial branches by
`git ls-remote`-ing all device repos in the `LineageOS` org, and writes the
result to the specified file.

Usage:

```console
$ repo-tool get-lineage-devices devices.json
```

### `repo-tool get-graphene-devices`

Calls the `https://releases.grapheneos.org/<device>-<channel>` API endpoints
for the `stable`, `beta` and `alpha` channels to get the channel metadata for
the devices specified in the given file.

Example:

```console
$ cat graphene_devices.json
[
  "akita",
  "barbet",
  ...
  "tegu",
  "tokay"
]
$ repo-tool get-graphene-devices graphene_devices.json channel_info.json
```

## License

GPLv3. See LICENSE.md for details.
