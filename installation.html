<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Installation / Updating - Robotnix</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="welcome.html"><strong aria-hidden="true">1.</strong> Welcome to robotnix</a></li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">2.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="modules/flavors.html"><strong aria-hidden="true">2.1.</strong> Flavors</a></li><li class="chapter-item expanded "><a href="modules/f-droid.html"><strong aria-hidden="true">2.2.</strong> F-Droid</a></li><li class="chapter-item expanded "><a href="modules/seedvault.html"><strong aria-hidden="true">2.3.</strong> Seedvault Backup</a></li><li class="chapter-item expanded "><a href="modules/microg.html"><strong aria-hidden="true">2.4.</strong> MicroG</a></li><li class="chapter-item expanded "><a href="modules/ota.html"><strong aria-hidden="true">2.5.</strong> Over-the-Air (OTA) Updater</a></li><li class="chapter-item expanded "><a href="modules/browsers.html"><strong aria-hidden="true">2.6.</strong> Browsers / Webview</a></li><li class="chapter-item expanded "><a href="modules/attestation.html"><strong aria-hidden="true">2.7.</strong> Remote Attestation</a></li><li class="chapter-item expanded "><a href="modules/prebuilt.html"><strong aria-hidden="true">2.8.</strong> Prebuilt Apps</a></li><li class="chapter-item expanded "><a href="modules/source.html"><strong aria-hidden="true">2.9.</strong> Source Directories</a></li><li class="chapter-item expanded "><a href="modules/other.html"><strong aria-hidden="true">2.10.</strong> Other Modules</a></li></ol></li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">3.</strong> Building</a></li><li class="chapter-item expanded "><a href="installation.html" class="active"><strong aria-hidden="true">4.</strong> Installation / Updating</a></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">5.</strong> Development</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Reference</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="options.html"><strong aria-hidden="true">6.1.</strong> Options</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Robotnix</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!--
SPDX-FileCopyrightText: 2021 Daniel Fullmer and robotnix contributors
SPDX-License-Identifier: MIT
-->
<h1 id="installing-for-the-first-time-with-optional-verified-boot"><a class="header" href="#installing-for-the-first-time-with-optional-verified-boot">Installing for the first time with (optional) verified boot</a></h1>
<blockquote>
<p>The following instructions are specific to Pixel phones using either the
Vanilla or GrapheneOS flavors.  For LineageOS, please refer to upstream
device-specific documentation on how to install LineageOS builds on your
device.</p>
</blockquote>
<p>It is assumed that you have successfully built your factory image and signed it
with your own keys, either by using the <code>factoryImg</code> Nix output or by running
<code>releaseScript</code>.  Make sure that you know the location of the image and the AVB
signing key.  The instructions in this document were tested on the Google Pixel
4a (sunfish).  Other Pixel phones are similar, but please refer to <a href="https://source.android.com/setup/build/running">this
upstream documentation</a>.</p>
<ol start="0">
<li>
<p>Before you can begin you have to boot the stock OS, go to &quot;Settings / About
phone&quot; and tap the &quot;Build number&quot; field 7 times to enable the &quot;Developer
options&quot; menu.  Next go to “Settings / System / Advanced / Developer
options” and enable “OEM unlocking”.  This option is greyed out until you connect your device to Google <a href="https://grapheneos.org/install#enabling-oem-unlocking">at least once</a>.
This is part of Google's so called Factory Reset Protection (FRP) for anti-theft protection. You do not need to insert a SIM or log into a Google Account to make the “OEM unlocking” option available, but connecting to the internet is required.</p>
</li>
<li>
<p>First reboot into the bootloader. You can either do that physically by
turning off your phone and then holding both the POWER and the VOLUME DOWN
button to turn it back on, or your can connect the phone to your computer
with USB Debugging turned on and issue</p>
<pre><code class="language-console">$ adb reboot bootloader
</code></pre>
</li>
<li>
<p>Connect your phone to your computer and run</p>
<pre><code class="language-console">$ fastboot devices
09071JEC217048  device
</code></pre>
</li>
<li>
<p>Unlock the bootloader by running</p>
<pre><code class="language-console">$ fastboot flashing unlock
</code></pre>
<p>Select the option to unlock the device and confirm. This step effectively
performs a factory reset, and will remove all user data from the device.</p>
</li>
<li>
<p>Flash your custom AVB signing key using</p>
<pre><code class="language-console">$ fastboot erase avb_custom_key
$ fastboot flash avb_custom_key ./avb_pkmd.bin
$ fastboot reboot bootloader
</code></pre>
</li>
<li>
<p>Unzip the factory image built by robotnix. Double check that you're
flashing to the correct device. To flash the image run</p>
<pre><code class="language-console">$ ./flash-all.sh
</code></pre>
<p>The factory image produced by robotnix includes the bootloader and radio
firmware in addition to the android image.  If you are certain the
bootloader and radio are already up to date, you can instead build the
standard <code>img</code> robotnix output, and flash the image with</p>
<pre><code class="language-console">$ fastboot -w --skip-reboot update sunfish-img-2020.11.06.04.zip
</code></pre>
<p>This will erase the <code>userdata</code> partition (<code>-w</code>) and prevent the automatic
reboot after flashing (<code>--skip-reboot</code>).</p>
<p>After flashing with the <code>flash-all.sh</code> script or with <code>fastboot update</code>,
return to the bootloader with</p>
<pre><code class="language-console">$ fastboot reboot bootloader
</code></pre>
</li>
<li>
<p>At this point you want to relock the bootloader to enable enforcement of
the verified boot chain.</p>
<pre><code class="language-console">$ fastboot flashing lock
</code></pre>
<p>This step has to be confirmed on the device.</p>
</li>
<li>
<p>After rebooting you will be greeted with a yellow exclamation mark and a
message like</p>
<blockquote>
<p>Your device is loading a different operating system.</p>
<p>Visit this link on another device:
g.co/ABH</p>
<p>ID: BA135E0F</p>
</blockquote>
<p>This is expected because Android Verified Boot is designed to warn the user
when not booting the stock OS, see
https://source.android.com/security/verifiedboot/boot-flow.  In fact, the
ID on the last line are the first eight characters of the fingerprint of
your AVB key.</p>
</li>
<li>
<p>Finally you can disable OEM unlocking and afterwards even the developer options again if you do not actively use them.
Note that if you later lose the ability to re-enable OEM unlocking, for example by pushing a bad update that you cannot rollback,
and you cannot push another working update because you also lost your signing keys,
you might not even be able to recover your device by flashing a stock image, effectively bricking the device.</p>
</li>
</ol>
<blockquote>
<p>If you are unable to enroll a custom AVB key on your device, you could theoretically skip steps 4, 6 and 8. This is highly discouraged as it leaves your device in the <a href="https://source.android.com/security/verifiedboot/boot-flow#communicating-verified-boot-state-to-users">vulnerable UNLOCKED state instead of being LOCKED with a custom root of trust.</a>.</p>
</blockquote>
<h2 id="updating-by-sideloading-ota-files"><a class="header" href="#updating-by-sideloading-ota-files">Updating by sideloading OTA files</a></h2>
<p>Preferably, you can update your Vanilla/GrapheneOS flavor device using true &quot;over-the-air&quot; mechanism provided by the <code>apps.updater</code> module with a server hosting the OTA files, as shown <a href="modules/ota.html">here</a>.
If this is not available, it is still possible to update by sideloading the OTA file.</p>
<blockquote>
<p>It is recommended to update using the OTA file instead of using <code>fastboot update</code> with a new <code>img</code>.
OTA files can also contain updates to the modem / bootloader that are not included in the <code>img</code> output.
<code>fastboot update</code> also cannot be used with a re-locked bootloader without wiping userdata.</p>
</blockquote>
<p>To install OTA updates you have to put the device in sideload-mode.</p>
<ol>
<li>
<p>First reboot into the bootloader. You can either do that physically by
turning off your phone and then holding both the POWER and the VOLUME DOWN
button to turn it back on, or your can connect the phone to your computer
with USB Debugging turned on and issue</p>
<pre><code class="language-console">$ adb reboot recovery
</code></pre>
<p>If you used the physical method, at the bootloader prompt use the VOLUME
keys to select “Recovery Mode” and confirm with the POWER button.</p>
</li>
<li>
<p>Now the recovery mode should have started and you should see a dead robot
with a read exclamation mark on top. If you see “No command” on the screen,
press and hold POWER. While holding POWER, press VOLUME UP and release
both.</p>
</li>
<li>
<p>At the recovery menu use the VOLUME keys to select “Apply update from ADB”
and use POWER to confirm.</p>
</li>
<li>
<p>Connect your phone to your computer and run</p>
<pre><code class="language-console">$ adb devices
List of devices attached
09071JEC217048  sideload
</code></pre>
<p>The output should show that the device is in sideload mode.</p>
</li>
<li>
<p>Now you can proceed to sideload the new update.</p>
<pre><code class="language-console">$ adb sideload sunfish-ota_update-2021.02.06.16.zip
</code></pre>
<p>The sideload might terminate at 94% with “adb: failed to read command:
Success”.  This is not an error even though it is not obvious, see also
<a href="https://np.reddit.com/r/LineageOS/comments/dt2et4/adb_failed_to_read_command_success/f6u352m">here</a>.</p>
</li>
<li>
<p>Once finished and the device doesn't automatically reboot just select
reboot from the menu and confirm.</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="building.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="development.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="building.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="development.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
